name: 'AI Review Demo'
on: pull_request

jobs:
  review:
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: AI Review
        id: inference
        uses: actions/ai-inference@v1.0.0
        with:
          model: openai/gpt-4.1
          system-prompt: |
            あなたはJavaコードレビュワーAIです。
            以下の観点でコードの修正点を1～2点、端的に指摘し、それぞれに簡単な修正例もコードブロックで示してください。
            - 可読性（分かりやすさ、命名、コメント、インデント、構造）
            - バグや論理的な誤り（バグ、ロジックミス、例外処理、エラーハンドリング）
            - コーディング規約・ベストプラクティス（規約遵守、冗長・非効率な書き方の有無）
            - パフォーマンス（無駄な計算、効率的なアルゴリズムやデータ構造）
            - セキュリティ（リスク、入力値検証やサニタイズ）
            - 保守性・拡張性（将来の変更容易性、再利用性、モジュール化）
            - テスト（テストコードの有無、テストしやすい構造）
            良い点は省略し、全体で1000トークン以内に収めてください。冗長な説明は避け、要点のみを箇条書きでまとめてください。
          prompt: |
            プルリクエストのタイトル: ${{ github.event.pull_request.title }}
            プルリクエストの本文: ${{ github.event.pull_request.body }}
          max-tokens: 1000

      - name: Comment on PR
        env:
          RESPONSE_FILE: ${{ steps.inference.outputs['response-file'] }}
          RESPONSE: ${{ steps.inference.outputs.response }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$RESPONSE_FILE" ] && [ -f "$RESPONSE_FILE" ]; then
            cat "$RESPONSE_FILE" > comment.txt
          else
            echo "$RESPONSE" > comment.txt
          fi
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt 