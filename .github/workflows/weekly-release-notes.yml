name: Weekly Release Notes

on:
  schedule:
    - cron: '0 0 * * 1' # 毎週月曜日 0:00 UTC に実行
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
    steps:
      - uses: actions/checkout@v4

      - name: Fetch merged PRs in the past 7 days
        id: fetch_prs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const since = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100
            });
            const merged = prs.filter(pr =>
              pr.merged_at &&
              pr.merged_at > since &&
              pr.base.ref === 'main'
            );

            let summary = '';
            for (const pr of merged) {
              const files = await github.paginate(github.rest.pulls.listFiles, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const fileList = files.map(f => `- ${f.filename} (${f.status})`).join('\n');
              summary += `### ${pr.title}\n${pr.body || 'No description.'}\n\n**Files changed:**\n${fileList}\n(PR #${pr.number})\n\n`;
            }

            fs.writeFileSync('merged_prs.md', summary);

      - name: Read prompt from file
        id: read_prompt
        run: |
          {
            echo "prompt<<EOF"
            cat merged_prs.md
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Summarize with AI
        id: ai
        uses: actions/ai-inference@v1
        with:
          prompt: ${{ steps.read_prompt.outputs.prompt }}
          system-prompt: |
            あなたは優秀なリリースノート作成者です。
            以下は、先週1週間でmainブランチにマージされたPull Requestの内容と変更ファイルの一覧です。
            これらの変更を読み取り、ユーザーや開発者が理解しやすいように、意義・改善点・影響範囲を整理し、全体を要約してください。
            Markdown形式で出力してください。
            PRの羅列ではなく、カテゴリや観点ごとにまとめてください。
          model: openai/gpt-4o
          max-tokens: 1000

      - name: Save AI output to file
        run: |
          echo "${{ steps.ai.outputs.output }}" > response.txt

      - name: Save release notes
        run: |
          if [ -n "${{ steps.ai.outputs['response-file'] }}" ] && [ -s "${{ steps.ai.outputs['response-file'] }}" ]; then
            cp "${{ steps.ai.outputs['response-file'] }}" weekly-release-notes.md
          else
            echo "(AI出力がありませんでした)" > weekly-release-notes.md
          fi

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: weekly-release-notes
          path: weekly-release-notes.md